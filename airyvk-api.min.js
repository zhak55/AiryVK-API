
// by Roman Zhak

(function(a){function b(){var a="";for(i=0;5>i;i++)a+=Math.ceil(15*Math.random()).toString(16);return a}function d(a,b,c,e,g){a[b]?c.apply(e):(g=g||0,1E3>g&&setTimeout(function(){d(a,b,c,e,g+1)},0))}function g(m){setTimeout(function(){var b=document.createElement("script");b.type="text/javascript";b.src=m||a.fastXDM.helperUrl;d(document,"body",function(){document.getElementsByTagName("HEAD")[0].appendChild(b)})},0)}function k(a,b){f.loaded?a.apply(b,[f]):l.push([b,a])}function n(){f.loaded=!0;for(var a=
l.length;a--;)l[a][1].apply(l[a][0],[f])}function p(a,b){k(function(c){var e=c.json.parse(a);if(e[0]){e[1]||(e[1]=[]);for(c=e[1].length;c--;)if(e[1][c]._func){var d=e[1][c]._func;e[1][c]=function(){var a=Array.prototype.slice.call(arguments);a.unshift("_func"+d);b.callMethod.apply(b,a)}}setTimeout(function(){if(!b.methods[e[0]])throw Error("fastXDM: Method "+e[0]+" is undefined");b.methods[e[0]].apply(b,e[1])},0)}})}function q(a,b){for(var c in b)a[c]&&"object"==typeof a[c]?q(a[c],b[c]):a[c]=b[c]}
if(!a.fastXDM){var h={},l=[],f={};a.fastXDM={_id:0,helperUrl:("https:"===location.protocol?"https:":"http:")+"//vk.com/js/api/xdmHelper.js",Server:function(m,r){this.methods=m||{};this.id=a.fastXDM._id++;this.filter=r;this.key=b();this.methods["%init%"]=this.methods.__fxdm_i=function(){a.fastXDM.run(this.id);if(this.methods.onInit)this.methods.onInit()};this.frameName="fXD"+this.key;this.server=!0;h[this.key]=[p,this]},Client:function(b){this.methods=b||{};this.id=a.fastXDM._id++;a.fastXDM.run(this.id);
if(0==window.name.indexOf("fXD"))this.key=window.name.substr(3);else throw Error("Wrong window.name property.");this.caller=window.parent;h[this.key]=[p,this];this.client=!0;a.fastXDM.on("helper",function(){a.fastXDM.onClientStart(this)},this);k(function(a){a.send(this,a.json.stringify(["%init%"]));var b=this.methods;setTimeout(function(){if(b.onInit)b.onInit()},0)},this)},onMessage:function(a){if(!a.data)return!1;var b=a.data.substr(0,5);if(h[b]){var c=h[b][1];if(c&&(!c.filter||c.filter(a.origin)))h[b][0](a.data.substr(6),
c)}},setJSON:function(a){f.json=a},getJSON:function(a){if(!a)return f.json;k(function(b){a(b.json)})},setEnv:function(a){for(i in a)f[i]=a[i];n()},_q:{},on:function(a,b,c){this._q[a]||(this._q[a]=[]);-1==this._q[a]?b.apply(c):this._q[a].push([b,c])},run:function(a){var b=(this._q[a]||[]).length;if(this._q[a]&&0<b)for(var c=0;c<b;c++)this._q[a][c][0].apply(this._q[a][c][1]);this._q[a]=-1},waitFor:d};a.fastXDM.Server.prototype.start=function(b,d){if(b.contentWindow)this.caller=b.contentWindow,this.frame=
b,a.fastXDM.on("helper",function(){a.fastXDM.onServerStart(this)},this);else{var c=this;d=d||0;50>d&&setTimeout(function(){c.start.apply(c,[b,d+1])},100)}};a.fastXDM.Server.prototype.append=function(a,b){var c=document.createElement("DIV");c.innerHTML='<iframe name="'+this.frameName+'" />';var d=c.firstChild,g=this;setTimeout(function(){d.frameBorder="0";b&&q(d,b);a.insertBefore(d,a.firstChild);g.start(d)},0);return d};a.fastXDM.Client.prototype.callMethod=a.fastXDM.Server.prototype.callMethod=function(){for(var b=
Array.prototype.slice.call(arguments),g=b.shift(),c=b.length;c--;)if("function"==typeof b[c]){this.funcsCount=(this.funcsCount||0)+1;var e=b[c],f="_func"+this.funcsCount;this.methods[f]=function(){e.apply(this,arguments);delete this.methods[f]};b[c]={_func:this.funcsCount}}d(this,"caller",function(){a.fastXDM.on(this.id,function(){k(function(a){a.send(this,a.json.stringify([g,b]))},this)},this)},this)};a.JSON&&"object"==typeof a.JSON&&a.JSON.parse&&a.JSON.stringify&&'{"a":[1,2,3]}'==a.JSON.stringify({a:[1,
2,3]}).replace(/ /g,"")?f.json={parse:a.JSON.parse,stringify:a.JSON.stringify}:a.fastXDM._needJSON=!0;a.postMessage?(f.protocol="p",f.send=function(a,b){a.caller.postMessage(a.key+":"+b,"*")},a.addEventListener?a.addEventListener("message",a.fastXDM.onMessage,!1):a.attachEvent("onmessage",a.fastXDM.onMessage),a.fastXDM._needJSON?(a.fastXDM._onlyJSON=!0,g()):n()):g()}})(window);"undefined"==typeof VK&&(VK={});VK._Rpc=null;VK._v=!1;VK._callbacks={};VK._initQueue=[];VK._inited=!1;
VK.init=function(a,b,d){d&&(VK._v=d);VK._inited?VK.isFunc(a)&&a():(VK._inited=!0,parent||b(),window.vk_onConnectionInit=function(){VK.isFunc(a)&&a()},VK.initXDConn())};
VK.initXDConn=function(){10<window.name.length?VK._Rpc=new easyXDM.Rpc({local:"/xd_receiver.html",onReady:function(){for(;0<VK._initQueue.length;){var a=VK._initQueue.pop();VK.isFunc(a)&&a()}window.vk_onConnectionInit()}},{remote:{callMethod:{},ApiCall:{}},local:{runCallback:function(a){var b;b=a.shift();VK.isFunc(VK._callbacks[b])&&VK._callbacks[b].apply(VK,a)}}}):(VK.fxdm=!0,VK._Rpc=new fastXDM.Client({onInit:function(){for(;0<VK._initQueue.length;){var a=VK._initQueue.pop();VK.isFunc(a)&&a()}window.vk_onConnectionInit()},
runCallback:function(a){var b;b=a.shift();VK.isFunc(VK._callbacks[b])&&VK._callbacks[b].apply(VK,a)},getHeight:function(a){var b=function(){var a=document.body.offsetHeight;if(a){if(void 0!==window.getComputedStyle)var b=window.getComputedStyle(document.body,null),a=a+parseInt(b.getPropertyValue("margin-top").replace("px","")),a=a+parseInt(b.getPropertyValue("margin-bottom").replace("px",""));else a+=parseInt(document.body.currentStyle.marginTop.replace("px","")),a+=parseInt(document.body.currentStyle.marginBottom.replace("px",
""));return a}return document.body.scrollHeight},d=function(){VK._Rpc.callMethod("setHeight",b())};setInterval(d,1E3);document.addEventListener("click",function(){setTimeout(d,0)},!1);document.addEventListener("DOMSubtreeModified",function(){setTimeout(d,0)});return a(b())}}),VK._Rpc.ApiCall=function(a,b){VK._Rpc.callMethod("ApiCall",a,b)})};
VK.callMethod=function(){var a=Array.prototype.slice.call(arguments),b;null!=VK._Rpc?VK.fxdm?VK._Rpc.callMethod.apply(VK._Rpc,a):(VK.isFunc(a[a.length-1])&&(b=a.pop()),VK._Rpc.callMethod(a,b)):(VK._initQueue.push(function(){VK.callMethod.apply(VK,a)}),VK.init())};VK.addCallback=function(a,b){b&&(VK._callbacks[a]=b)};VK.removeCallback=function(a){VK._callbacks[a]&&delete VK._callbacks[a]};VK.isFunc=function(a){return"[object Function]"===Object.prototype.toString.call(a)};VK.params={};
VK.loadParams=function(a){if("Object"==typeof a)VK.params=a;else{a=a.substr(a.indexOf("?")+1).split("&");for(var b=a.length;b--;){var d=a[b].split("=");VK.params[d[0]]=decodeURIComponent(d[1])}}};VK.addScript=function(a){var b=document.createElement("script");b.type="text/javascript";b.src=a;document.getElementsByTagName("head")[0].appendChild(b)};
VK.api=function(){var a=Array.prototype.slice.call(arguments),b;null!=VK._Rpc?(VK.isFunc(a[a.length-1])&&(b=a.pop()),a[1]||(a[1]={}),!a[1].v&&VK._v&&(a[1].v=VK._v),VK._Rpc.ApiCall(a,b)):(VK._initQueue.push(function(){VK.api.apply(VK,a)}),VK.init())};
VK.Modules={callbacks:{},loaded:function(a){if(this.callbacks[a])for(var b=this.callbacks[a].length;b--;)if(VK.isFunc(this.callbacks[a][b]))this.callbacks[a][b]()},load:function(a,b,d){this.callbacks[a]?this.callbacks[a].push(b):(this.callbacks[a]=[b],null==d&&(d="http://vk.com/js/api/modules/"+a+".js"),VK.addScript(d))}};VK.showPortlet=function(a){VK.callMethod("showPortlet",a)};"https:"!==VK._protocol&&(VK._protocol="https:"===location.protocol?"https:":"http:");
"https:"!==VK._protocol&&VK.callMethod("getLocationProtocol",function(a){"https:"===a&&(VK._protocol="https:")});(function(){try{var a=document.getElementsByTagName("script");VK._base_domain=a[a.length-1].src.match(/^https?:\/\/((?:\w+\.)*vk.com)/)[1]}catch(b){}})();
VK.Widgets||(VK.Widgets=function(){var a={},b="Comments CommentsBrowse Auth Group Post Donate Like Poll Recommended Subscribe Ads".split(" ");VK.xdConnectionCallbacks=[];for(var d=b.length;d--;)(function(b){a[b]=function(){var a=arguments;VK.xdConnectionCallbacks.push(function(){VK._iframeAppWidget=!0;VK.Widgets[b].apply(VK,a)});VK._openApiAttached||(VK.callMethod("_getAppInfo",function(a){var b=VK._base_domain&&VK._base_domain.match(/^(\w+\.)*vk.com$/)?VK._base_domain:"vk.com";VK._apiId=a[0];VK._browserHash=
a[1];VK.addScript(VK._protocol+"//"+b+"/js/api/openapi.js?106")}),VK._openApiAttached=!0)}})(b[d]);return a}());
VK.External={showPaymentBox:function(a){VK.callMethod("showPaymentBox",a)},showSettingsBox:function(a){VK.callMethod("showSettingsBox",a)},showInstallBox:function(){VK.callMethod("showInstallBox")},showInviteBox:function(){VK.callMethod("showInviteBox")},resizeWindow:function(a,b){VK.callMethod("resizeWindow",a,b)},scrollWindow:function(a,b){VK.callMethod("scrollWindow",a,b)},setLocation:function(a,b){VK.callMethod("setLocation",a,b)},setTitle:function(a){VK.callMethod("setTitle",a)},saveWallPost:function(a){VK.callMethod("saveWallPost",
a)},showProfilePhotoBox:function(a){VK.callMethod("showProfilePhotoBox",a)},showMerchantPaymentBox:function(a){VK.callMethod("showMerchantPaymentBox",a)}};
(function(e){function f(a,b){var c=k.call(arguments,2);r.push(function(){h=!0;a.apply(b||this,c)});x()}function l(){h=!1;x()}function x(){!h&&r.length&&(r.shift()(),h||l())}function s(a){var b={};a.session&&(m(d,a.session),m(b,a.session),d.status=b.status=a.status,d.id=b.id=a.session.mid);d.id||e.Observer.subscribe("auth.login",function(){e.Auth.getLoginStatus(s)});return b}function d(a){this.data={};a&&(this.open=p=!0,e.Auth.getLoginStatus(s))}var r=[],h=!1,y=Array.prototype,t=Function.prototype.bind,
k=y.slice,u=window.location,p=!1,D=u.href,q=null,v=!1,m=function(a,b){if(null===b)return a;for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a};Object.keys=Object.keys||function(a){var b=[],c;for(c in a)a.hasOwnProperty.call(a,c)&&b.push(c);return b};var z=function(a,b){if(t&&a.bind===t)return t.apply(a,k.call(arguments,1));a="function"===typeof a?a:0;var c=k.call(arguments,1);if(!a)throw new TypeError("Must be a function");return function(){return a.apply(b,c.concat(k.call(arguments)))}};d.login=
function(a,b){var c=navigator.userAgent.toLowerCase(),c=/(ipad|iphone|ipod|android|blackberry|windows ce)/i.test(c),c=["client_id="+e._apiId,"display="+(c?"mobile":"page"),"redirect_uri="+(b||D),"response_type=token"];a&&c.push("scope="+a);d.again("https://oauth.vk.com/authorize?"+c.join("&"))};d.again=function(a){if(a)return u.assign(a);u.reload()};!e.Auth&&function(){for(var a=window.location.search.substr(1).split("&"),b=0,c;b<a.length;b++)c=a[b].split("="),d[c[0]]=c[1];d.latest="5.23";d.id=d.viewer_id}();
var E=function(a,b,c){if(1>arguments.length)throw Error("Not enough data to filter.");var d=[],n=this[0],e=y.slice.call(arguments,2),f=0,g,k,h,m=Object.prototype.toString;q="found";for(k=Object.keys(a).length;f<n.length;f++){complete=0;for(g in a)a.hasOwnProperty(g)&&g in n[f]&&(h=c?n[f][g][c.token]:n[f][g],"[object RegExp]"===m.call(a[g])&&a[g].test(h)&&complete++,"function"===typeof a[g]&&a[g].call(e,h)&&complete++,a[g]===h&&complete++);complete===k&&d.push(n[f])}this.data.found="function"===typeof b?
b.call(e,d):d;l()},F=function(a,b){q=a[0];var c=this,d;(p?e.Api.call:e.api)(a.join("."),"object"===typeof b?b:{},function(b){b.response&&(d=b.response.items||b.response,c["_"+a[0]]=c[0]=d);if(b.error)throw Error(b.error.error_msg);l()})},A=function(a,b){var c,d=0,e=a.length;if(void 0===e)for(c in a){if(!1===b.call(a[c],c,a[c]))break}else for(c=a[0];d<e&&!1!==b.call(c,d,c);c=a[++d]);return a},w=[" method is available only from your server."," method is available only to standalone-applications."],
B={status:w[1],secure:w[0],orders:w[0]};A("users groups friends wall photos video status secure orders audio newsfeed likes storage accounts auth widgets pages board notes places polls docs fave notifications stats search apps utils database ads execute".split(" "),function(a,b){d.prototype[b]=function(a,d){if(B[b])throw Error(b+B[b]);f(F,this,[b,a],d);return this}});A("showInstallBox showSettingsBox showRequestBox showInviteBox showOrderBox showPaymentBox showLeadsPaymentBox showProfilePhotoBox saveWallPost resizeWindow scrollWindow setTitle setLocation scrollTop scrollSubscribe saveProfilePhoto".split(" "),
function(a,b){d[b]=function(){e.callMethod.apply(null,[b].concat(k.call(arguments)))}});var C={remoteHandlers:function(a,b,c){"Scroll"===a&&d.scrollSubscribe("boolean"===typeof b?b:!1);e[c?"removeCallback":"addCallback"]("on"+a,b)},remoteHandlersOauth:function(a,b,c){e.Observer[c?"unsubscribe":"subscribe"](a,function(a){b.call(null,s(a))})}};d.on=function(a,b,c){if("object"===typeof a)for(var d in a)C[p?"remoteHandlersOauth":"remoteHandlers"](d,a[d],c);else C[p?"remoteHandlersOauth":"remoteHandlers"](a,
b,c)};d.off=function(a,b){d.on(a,b,!0)};var G=function(a){for(var b=0,c=this[0],d=c.length,e=c[0];b<d&&!1!==a.call(e,b,e);e=c[++b]);l()},H=function(a){var b="_"+q;this.merged||(this.merged={});this.merged[a||b]||(this.merged[a||b]=[]);this.merged[a||b].push("_found"===b?this.data.found:this[b]);l()},I=function(a){v=!0;var b="_"+q;a||(this[b]?rawData=this[b]:rawData=this.data[b]);a&&(b="_"+a,this[b]&&(rawData=this[b]),this.data[b]&&(rawData=this.data[b]),this.merged&&this.merged[a]&&(rawData=this.merged[a]));
l()};m(d.prototype,{res:function(a){f(z(function(b){delete this[0];a.call(this.context||this,v?rawData:m({},this));v=!1;l()},this));return this},filter:function(a,b,c){f(E,this,a,b,c);return this},apiece:function(a){f(G,this,z(a,this));return this},merge:function(a){f(H,this,a);return this},raw:function(a){f(I,this,a);return this}});this.vk=d})(VK);
